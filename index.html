<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace conceptuel</title>
    <script src="asset/js/d3.min.js"></script>
    <script src="asset/js/d3-hexbin.min.js"></script>
    <script src="asset/js/espaceConceptuel.js"></script>
    <script src="asset/js/hex-lib.js"></script>
    <script src="asset/js/hex-algorithms.js"></script>
</head>
<body>
    <div id="ec"></div>
    <div id="grid"></div>
</body>
<script>
    let oEc = new espaceConceptuel({'idCont':'ec'}),
    hexas = makeHexagonalShape(1),
    layout = new Layout(Layout.flat, new Point(100, 100), new Point(0, 0)),
    padding = 0,
    vb = getViewBox(hexas),
    polygonVerticesFlat = layout
            .polygonCorners(new Hex(0,0,0))
            .map(p=>`${p.x.toFixed(0)},${p.y.toFixed(0)}`)
            .join(" "),
    svgG = d3.select('#grid').append('svg')
        .attr('id','svgPlan_0')
        //.attr('width',100).attr('height',100)
        .attr('viewBox',vb.join(' ')),
    gCpt = svgG.selectAll('g').data(hexas).enter().append('g')
        .attr('id',(h,i)=>{
            h.niv = 0;
            h.id = 'gPlan_'+h.niv+'_'+h.q+'_'+h.r+'_'+h.s;
            h.idSvg = 'svgPlan_0';
            return h.id;
        })
        .attr('transform',h=>hexCenter(h).transform),
    polys = gCpt.append('polygon').attr('points',polygonVerticesFlat)
            .attr('fill','#86abcb42').attr('stroke','black'),
    center = gCpt.append('circle').attr('x',0).attr('y',0).attr('r',10)
            .attr('fill','green').attr('stroke','black')
            .on('click',addEC);

    function hexCenter(hex) {
        let p = layout.hexToPixel(hex);
        return {
            x: p.x,
            y: p.y,
            transform: `translate(${p.x.toFixed(0)},${p.y.toFixed(0)})`,
        }
    }
    function getViewBox(hexas) {
        let rect = hexSetBounds(layout, hexas),
        left = rect.left - padding,
        top = rect.top - padding,
        width = rect.right - rect.left + 2 * padding,
        height = rect.bottom - rect.top + 2 * padding;
        return [left, top, width, height];
    }
    function addEC(e,d){
        let ps = getPosiScale(d),
        svg = svgG.append('svg')
            .attr('id','svgPlan_'+(d.niv+1)+'_'+d.q+'_'+d.r+'_'+d.s)
            .attr('width',ps.width).attr('height',ps.height)
            .attr('viewBox',vb.join(' '))
            .attr('x',ps.x)
            .attr('y',ps.y)
        hexas = makeHexagonalShape(1),
        gCpt = svg.selectAll('g').data(hexas).enter().append('g')
            .attr('id',(h,i)=>{
                h.niv = d.niv+1;
                h.id = 'gPlan_'+h.niv+'_'+d.q+'_'+d.r+'_'+d.s+'_'+h.q+'_'+h.r+'_'+h.s;
                h.idSvg = svg.attr('id');
                h.idSvgP = d.idSvg;
                return h.id;
            })
        .attr('transform',h=>hexCenter(h).transform),
        polys = gCpt.append('polygon').attr('points',polygonVerticesFlat)
                .attr('fill','#86abcb42').attr('stroke','black'),
        center = gCpt.append('circle').attr('x',0).attr('y',0).attr('r',10)
                .attr('fill','green').attr('stroke','black')
                .on('click',addEC);        

    }
    function getPosiScale(d){
        let p = hexCenter(d), n=d3.select('#'+d.id).node(), 
        bb = n.getBBox();
        if(d.niv > 0){
            let svg = d3.select('#'+d.idSvg), svgP = d3.select('#'+d.idSvgP),
            rectG = svgG.node().getBoundingClientRect(), 
            rectP = svgP.node().getBoundingClientRect(), 
            rect = svg.node().getBoundingClientRect(),        
            sT = rectP.width / rect.width,
            sP = rectG.width / rect.width,
            w = Math.round(Number(svg.attr('width'))/sT),
            h = Math.round(Number(svg.attr('height'))/sT),
            x = Math.round(Number(svg.attr('x'))+w+(p.x/sP)),
            y = Math.round(Number(svg.attr('y'))+h+(p.y/sP));
            return {'x':x,'y':y, 'width': w, 'height':h}
        }else  
            return {'x':p.x+bb.x,'y':p.y+bb.y, 'width': bb.width, 'height':bb.height}
    }

</script>
</html>